
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="sn-tabela-mes.html">
<link rel="import" href="sn-receita-bruta-filters.html">

<dom-module id="sn-receita-bruta">
   <style is="custom-style" include="iron-flex"></style>
   <template>
      <style>
         :host {
         display: block;
         padding: 10px;
         }
         .card {
         box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
         padding: 16px;
         margin: 24px;
         border-radius: 5px;
         background-color: #fff;
         color: #757575;
         }
         .circle {
         display: inline-block;
         height: 64px;
         width: 64px;
         border-radius: 50%;
         background: #ddd;
         line-height: 64px;
         font-size: 30px;
         color: #555;
         text-align: center;
         }
         h1 {
         font-size: 22px;
         margin: 16px 0;
         color: #212121;
         }
         paper-material {
         background:#FFF;
         padding:8px;
         }
      </style>
      
      <paper-material on-fill-failed="_fillFailedHandler">   

         <sn-receita-bruta-filters 
          id="filters"
          on-faixas-changed="_faixasChangedHandler"
          on-build-faixas="_buildFaixasHandler"
          on-path-changed="_pathChangedHandler">
        </sn-receita-bruta-filters>

         

    <sn-tabela-mes 
            format-as-integer
            editable
            total
            total-bellow
            id="tableQTDNavios"
            db="receita-qtd-navios" 
            on-tabela-mes-build="_tabelaMesBuildHandler"
            path="{{_path}}"
            dimensions="[[ _selectedFaixas ]]" 
            filter="#faixaDWT"
            header="Quantidade de Navios"></sn-tabela-mes>

         <sn-tabela-mes 
            format-as-integer
            editable
            total
            total-bellow
            id="tableQTDRebocadores"
            db="receita-qtd-rebocadores" 
            on-tabela-mes-build="_tabelaMesBuildHandler"
            path="{{_path}}"
            dimensions="[[ _selectedFaixas ]]"  
            filter="#faixaDWT"
            header="Quantidade de Rebocadores"></sn-tabela-mes>
		

         <sn-tabela-mes 
            id="tableTarifas"
            db="receita-tarifa" 
            format-as-integer
            on-tabela-mes-build="_tabelaMesBuildHandler"
            path="{{_path}}"
            dimensions="[[ _selectedFaixas ]]"  
            filter="#faixaDWT"
            header="Tarifa"></sn-tabela-mes>

          <sn-tabela-mes 
          	editable
            id="tableReajuste"
            db="receita-reajuste" 
            on-tabela-mes-build="_tabelaMesBuildHandler"
            path="{{_path}}"
            dimensions="[[ _selectedFaixas ]]"  
            filter="#faixaDWT"
            percent
            header="Reajuste"></sn-tabela-mes>

         <sn-tabela-mes 
            total
            total-bellow
            id="tabelaTotal"
            db="receita-total" 
            path="{{_path}}"
            dimensions="[[ _selectedFaixas ]]"  
            filter="#faixaDWT"
            header="Total R$"></sn-tabela-mes>

      </paper-material>
   </template>
   <script>
      Polymer({
      
        is: 'sn-receita-bruta',
        onPageSelected:function(){
          this.$.filters.currentFilial = window.CURRENT_FILIAL;
        },
        _tabelaMesBuildHandler:function(){
            this.cancelAsync(this._totalAsync)
            this._totalAsync  = this.async(function(){

              var tipoTarifa  = this.$.filters.$.inputTipoTarifa.value
              var moeda       = this.$.filters.$.inputMoeda.value
              var vlrCambio   = parseFloat(this.$.filters.$.inputCambio.value);


              var A = this.$.tableQTDNavios
                          .getStructuredData();
              var B = null;
              var C = this.$.tableTarifas.getStructuredData();
              var D = this.$.tableReajuste.getStructuredDataAsPercent();

              if(tipoTarifa == "REBOCADOR") {
				          B = this.$.tableQTDRebocadores.getStructuredData();
              }
              else {
                  B = this.$.tableQTDRebocadores.getSampleData(1,{isStructured:true});
              }
              
              this.$.tabelaTotal.productABC(A,B,C,D,
                {tax:moeda == "DOLAR" ? vlrCambio : 1});
              this.$.tabelaTotal.applyClone();
            },10)
        },
        _buildFaixasHandler:function(e,d){

          var S = this.$.tableTarifas.fill(d.faixasTarifa,'VLR_LINER');
          console.log(S);

          if(_.isNaN(S) || S == 0) {
            this.$.tableTarifas.fill(d.faixasTarifa,'VLR_TRAMP');
          }
          
          this._selectedFaixas = _.keys(d.faixasTarifa);
        },
        _fillFailedHandler:function(){
          this.async(function(){
            this.$.filters.$.terminalList.selected = 0;
          },333)
        },
        _pathChangedHandler:function() {
          this._path = this.$.filters.path;
        },
        _faixasChangedHandler:function(){
          this._selectedFaixas =  this.$.filters.selectedFaixas;
        }
        
      });
      
   </script>
</dom-module>


