<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<dom-module id="sn-tabela-mes">
    <template>
        <style>
            :host {
                display: block;
                position:relative;
            }
            h4 {
                margin: 0px;
                margin-top: 27px;
                position: relative;
                top: 4px;
                left: 22px;
                padding-top: 7px;
                font-size: [[headerFontSize]]px;
            }

            paper-datatable /deep/ td.bound-cell span {
                flex: 1;
                font-size: 11px;
                min-width: 30px!important;
            }

            paper-datatable /deep/ tr td, paper-datatable /deep/ tr th {
                padding: 6px 14px 6px 19px !important
            }  
            paper-datatable /deep/ tr.progress{
               display:none;
            } 
            paper-datatable /deep/ tr.progress[data-progress]{
               display:table-row;
            }
            paper-fab {
                position: absolute;
                bottom: -12px;
                left: 67px;
                z-index: 1;
                background: #CFD8DC;
                color: #000;
            }
            #errorLabel {
                color:#D50000;margin-top: -7px;
            }
        </style>
        <h4 on-click="_selectText">{{header}}</h4>

        <h4 id="errorLabel">{{_errorLabel}}</h4>

        <template is="dom-if" if="[[dimEditor]]">
            <paper-fab icon="av:playlist-add" mini on-click="_openDialog"></paper-fab>
        </template>

        <paper-datatable data="{{data}}" id="dataTable" percent='{{percent}}'>

            <paper-datatable-column 
                header="#" 
                property="dimension" 
                align="left" 
                tooltip="" 
                editable='[[dimEditor]]' 
                dialog='[[dimEditor]]'>
            </paper-datatable-column>

            <template is="dom-if" if="{{meta}}">
                <paper-datatable-column header="{{metaHeader}}" property="meta" align="right" editable='{{metaEditable}}' dialog='{{metaEditable}}' default="0" type="Number" tooltip=""></paper-datatable-column>
            </template>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Jan" property="1" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Fev" property="2" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Mar" property="3" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Abr" property="4" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Mai" property="5" align="right" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Jun" property="6" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Jul" property="7" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Ago" property="8" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Set" property="9" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Out" property="10" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Nov" property="11" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column editable='[[editable]]' dialog='[[editable]]' type="Number" header="Dez" property="12" align="right" default="0" tooltip=""></paper-datatable-column>
            <paper-datatable-column header="Total" property="total" align="right" default="0" type="Number" tooltip="" id="totalColumn"></paper-datatable-column>
        </paper-datatable>
        <!--
        <template is="dom-if" if="{{_dataIsEmpty(data)}}">
            <paper-progress indeterminate style="width:100%"></paper-progress>
            Carregando...
        </template>
    -->
        <!--
	        <style>
	        paper-progress {
	        	--paper-progress-secondary-color:#D50000;
	        	--paper-progress-active-color: #FF1744;
	        }
	        </style>
	    -->
        <paper-dialog id="dialog" style="width:400px">
          <h4 style="margin: 0;padding: 0;">Inserir linha: {{header}}</h4>
          <paper-input label="Dimensão:" 
            style="width: 96%;
                margin: 9px;
                padding: 0;"  
                always-float-label 
                value="{{_dimensionLabel}}"
                placeholder="exemplo: Uniformes"></paper-input>
          <paper-button style="
            font-weight: bold;
            background: #CFD8DC;
            margin: 0;
            padding: 10px;
            width: 100%;" raised on-click="_addDim1">Inserir 1 linha</paper-button>
          <paper-button style="
            font-weight: bold;
            background: #CFD8DC;
            margin: 0;
            padding: 10px;
            width: 100%;" raised on-click="_addDim2">Inserir par(preço/quantidade)</paper-button>
        </paper-dialog>
    </template>
    <script>
        window.STRUCTURED_CACHE={};
        Polymer({
            is: 'sn-tabela-mes',
            properties: {
                header: {
                    type: String,
                    value: "Header"
                },
                data: {
                    value: [],
                    observer: '_dataChanged'
                },
                db: {
                    observers: '_buildDB',
                    type: String
                },
                headerFontSize:{
                    value:14
                },
                percent: {
                    type: Boolean,
                    value: false
                },
                path: {
                    type: String,
                    observer: '_pathChanged'
                },
                dimEditor:{
                    type: Boolean,
                    value: false
                },
                editable: {
                    type: Boolean,
                    value: false
                },
                oneLine:{
                    type:Boolean
                },
                sortMap:{
                	type:Boolean
                },
                total: {
                    type: Boolean
                },
                totalBellow: {
                    type: Boolean
                },
                meta: {
                    type: Boolean
                },
                metaHeader: {
                    type: String
                },
                metaEditable: {
                    type: Boolean
                },
                notSave: {
                    type: Boolean
                },
                commuteProduct:{
                    type:Boolean
                },
                formatAsInteger:{
                    type:Boolean
                },
                dimensions: {
                    type: Array
                },
                fillValue: {
                    type: Number,
                    value: 0
                },
                filter: {
                    type: String
                },
                observerIfIsZero:{
                    type:Boolean,
                    value:false
                }
            },
            observers: ['_pathDBObserver(_path,db)', '_dataDimensionsObserver(data,dimensions)'],
            ready: function() {
                this.addEventListener('data-changed', this._changeHandler);
                this.addEventListener('keydown', this._keyPressHandler);
                this.addEventListener('fill-back', this._fireFillBack);
                this.addEventListener('fill-forward', this._fireFillForward);
                if(this.observerIfIsZero) {
                    setInterval(function()
                    {
                        clearTimeout(this.observerIfIsZeroJob);

                        this.observerIfIsZeroJob = 
                        setTimeout(function(){

                            var el = this.$.dataTable.querySelector("* /deep/ [grand-total]");
                            if(!el)
                                return;
                            var v = el.innerHTML;  

                            if(v=="0") { this.fire('is-zero') }

                        }.bind(this),1000)
                    }
                    .bind(this),1000)
                }
                if(!this.total)
                    this.$.totalColumn.inactive = true;
                this._configFormat();
            },
            _openDialog:function(){
                this.$.dialog.open();
            },
            _configFormat:function(){

                _.each(this.querySelectorAll('* /deep/ paper-datatable-column'),function(c){
                    if(_.contains( ["%","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez","Total"],c.header))
                        if(this.percent)
                            c.formatValue = this._formatValuePercent.bind(this)
                        else
                            c.formatValue = this._formatValue.bind(this);
                },this);

            },
            _formatValue:function(x){
                    
                return x.formatMoney(this.formatAsInteger ? 0 : 2);
            },
            _formatValuePercent:function(x){
                return x.formatMoney(this.formatAsInteger ? 0 : 2) + "%";
            },
            _selectText:function(){
                var doc = document
                    , text = this.querySelector('* /deep/ table')
                    , range, selection
                ;    
                if (doc.body.createTextRange) {
                    range = document.body.createTextRange();
                    range.moveToElementText(text);
                    range.select();
                } else if (window.getSelection) {
                    selection = window.getSelection();        
                    range = document.createRange();
                    range.selectNodeContents(text);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            },
            _fireFillBack: function(e) {
                var d = event.detail;
                var D = this.data[d.row];
                var v = this.data[d.row][d.col];
                var k = d.col;
                D['1']  = k > 1 ? v : D['1'];
                D['2']  = k > 2 ? v : D['2'];
                D['3']  = k > 3 ? v : D['3'];
                D['4']  = k > 4 ? v : D['4'];
                D['5']  = k > 5 ? v : D['5'];
                D['6']  = k > 6 ? v : D['6'];
                D['7']  = k > 7 ? v : D['7'];
                D['8']  = k > 8 ? v : D['8'];
                D['9']  = k > 9 ? v : D['9'];
                D['10'] = k > 10 ? v : D['10'];
                D['11'] = k > 11 ? v : D['11'];
                D['12'] = k > 12 ? v : D['12'];
                this.data[d.row] = _.clone(D)
                this.data = _.clone(this.data);
            },
            _fireFillForward: function(e) {
                var d = event.detail;
                var D = this.data[d.row];
                var v = this.data[d.row][d.col];
                var k = d.col - 1;
                D['1']  = k < 1 ? v : D['1'];
                D['2']  = k < 2 ? v : D['2'];
                D['3']  = k < 3 ? v : D['3'];
                D['4']  = k < 4 ? v : D['4'];
                D['5']  = k < 5 ? v : D['5'];
                D['6']  = k < 6 ? v : D['6'];
                D['7']  = k < 7 ? v : D['7'];
                D['8']  = k < 8 ? v : D['8'];
                D['9']  = k < 9 ? v : D['9'];
                D['10'] = k < 10 ? v : D['10'];
                D['11'] = k < 11 ? v : D['11'];
                D['12'] = k < 12 ? v : D['12'];
                this.data[d.row] = _.clone(D)
                this.data = _.clone(this.data);
            },
            applyClone:function(){
                this.data = _.clone(this.data);
            },
            _dataChanged: function() {
                this.cancelAsync(this._workTotalsJob)

                this._workTotalsJob = 
                    this.async(function()
                    {
                        this._workTotals();
                    })
                //console.log(this,'_dataChanged',this.path,this.db,JSON.stringify(this.data))
            },
            _workTotals:function()
            {
                if (this.total && this.data)
                    _.each(this.data, function(D) {
                        D.total = 
                            (+D['1'] ) + 
                            (+D['2'] ) + 
                            (+D['3'] ) + 
                            (+D['4'] ) + 
                            (+D['5'] ) + 
                            (+D['6'] ) + 
                            (+D['7'] ) + 
                            (+D['8'] ) + 
                            (+D['9'] ) + 
                            (+D['10']) + 
                            (+D['11']) + 
                            (+D['12']);
                    })

                if(_.size(this.data) == 1) {
                    jQuery(this.$.dataTable.querySelector('* /deep/ table tr[total]')).remove();
                    this.totalDataPorMes = _.first(this.data)
                    this._buildDB()
                    return;
                }

                if (this.totalBellow) 
                {
                	jQuery(this.$.dataTable.querySelector('* /deep/ table tr[total]')).remove();
                    //define
                    var table = this.$.dataTable.querySelector('* /deep/ table')
                    //Let trTotal:
                    var trTotal = document.createElement('tr'); 
                    trTotal.innerHTML += "<td style=\"border-top: 1px dashed #dbdbdb;\">"
                                            +"<span style=\"font-size: 10px;text-transform: uppercase; font-weight: bold;color: rgba(0,0,0, .54);\">"
                                            +"Total:</span></td>";
                    trTotal.setAttribute('total','')
                    table.appendChild(trTotal);

                    //se for meta preencha com informação vazia
                    if(this.meta)
                    {
                        var css = "class=\"bound-cell\" style=\"text-align:right;border-top: 1px dashed #dbdbdb;\""
                        trTotal.innerHTML += "<td "+css+" ><span>-</span></td>";
                    }

                    //para cada mes inclua um total
                    _.each([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],function(m)
                    {
                        var css = "class=\"bound-cell\" style=\"text-align:right;border-top: 1px dashed #dbdbdb\"";          
                    	trTotal.innerHTML += "<td "+css+" mes=\""+m+"\"><span>"+(this.commuteProduct ? 1 : 0)+"</span></td>";
                    }
                    ,this)

                    //crie grand-total
                    if(this.total)
                    	trTotal.innerHTML += "<td class=\"bound-cell\" style=\"text-align:right;border-top: 1px dashed #dbdbdb\" grand-total><span>0</span></td>";
                	
                    this._errorLabel = "";
                    
                    const PreçoAloneMap = {};

                	_.each(this.data, function(D) {
                		var trTotal = this.$.dataTable.querySelector('* /deep/ table tr[total]');
                		_.each([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],function(k)
                		{
	                		var tdSpanMes = trTotal.querySelector('td[mes="'+k+'"] span');
                            var tdSpanMesText  = tdSpanMes.innerText;
                            var previousTrValue = parseFloat(tdSpanMesText);

                            //algumas tabelas utilizam produto como comutador
                            if(this.commuteProduct)
                                tdSpanMes.innerText = D[k] * previousTrValue;
                            else {
                                const isPQ  = D.dimension.match(/(Qntd:|Preço:)/)
                                const isP   = D.dimension.match(/(Preço:)/)

                                if(isPQ) {
                                    if(isP)
                                        return PreçoAloneMap[D.dimension] = true ;
                                    else {
                                        const Dpreco = 
                                        _.chain(this.data)
                                            .filter(function(Dx){
                                                const dim = Dx.dimension
                                                return  dim.match(/Preço/) && 
                                                        dim.replace("Preço:","Qntd:") == D.dimension;
                                            })
                                            .first()
                                            .value();

                                        if(!Dpreco) {
                                            this._errorLabel = 
                                            ["Não foi possível encontrar a linha de [Preço] para: [",  
                                                D.dimension ,"] !"].join("")
                                        }
                                        else{
                                            delete PreçoAloneMap[Dpreco.dimension]
                                            tdSpanMes.innerText = (Dpreco[k]*D[k]) + previousTrValue;
                                        }
                                    }

                                }
                                else
                                    tdSpanMes.innerText = D[k] + previousTrValue;
                            }
                			
                		}
                        ,this); 
                    }
                    ,this);
                    if(_.size(PreçoAloneMap)>0)
                        this._errorLabel += 
                        ["Não foi possível encontrar a linha de [Quantidade] para: [",  
                            _.keys(PreçoAloneMap) ,"] !"].join("")

                    this.totalDataPorMes = {};
                    //trabalha grandTotal
                    var GrandTotalSigma = 0;
                    var trTotal = this.$.dataTable.querySelector('* /deep/ table tr[total]');
                    _.each([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],function(k)
                    {
                        var span = trTotal.querySelector('td[mes="'+k+'"] span');
                        var tdSpanMesText = span.innerText;
                        var tdSpanMesValue = parseFloat(tdSpanMesText);
                        GrandTotalSigma += tdSpanMesValue;

                        span.innerText = this._formatValue(tdSpanMesValue);

                        this.totalDataPorMes[k] = tdSpanMesValue
                    },this);
                    if(trTotal.querySelector('[grand-total]') === null)
                        trTotal.innerHTML += "<td grand-total></td>"
                    trTotal.querySelector('[grand-total]').innerHTML = '<span style="    font-size: 13px;">'+this._formatValue(GrandTotalSigma)+'</span>';
                    trTotal.querySelector('[grand-total]').setAttribute('data-value',GrandTotalSigma);
                }
                this._buildDB()
                this.$.dataTable.progress = false;

                if(this.oneLine && _.size(this.data) > 1)
                    this.data = [_.first(this.data)];

                this._formatValues();
            },
            _dataIsEmpty: function(data) {
                return _.isEmpty(data)
            },
            _keyPressHandler:function(e){
                if(e.keyCode == 13)
                    this._buildDB();
            },
            _changeHandler: function(e) 
            {
                var D = _.pluck(this.data,'dimension');;
                if(!_.isEmpty(D))   
                    this.dimensions = D

                if(this.dimEditor) {
                    var P = e.detail.path
                    if(P && !P.match("dimension"))
                        this._buildDB()
                    if(!P)
                        this._buildDB()
                }
                else
                    this._buildDB()

                if(!this.dimensions)
                    return;
                this.async(function(){
                    const X = this.dimensions.join(";"); 
                    if( (/(Preço)|(Qntd)/).test(X) ) 
                    {
                        this._workTotalPrecoQntd()
                    }
                },1)
            },
            _workTotalPrecoQntd:function(){
                const TR = this.$.dataTable.querySelectorAll('* /deep/ tr[data-key]')
                _.each(TR,function(tr,i){
                    if((/Qntd/).test(tr.innerText)){
                        const hasTotalTr = jQuery(tr).next().attr('pq-total') === "";

                        if(!hasTotalTr){
                            jQuery(tr).next().attr('pq-total').remove()
                        }

                        jQuery(tr).after('<tr pq-total ignore><td ignore>Total:</td></tr>')
                        const totalTr = jQuery(tr).next()
                        _.each([1,2,3,4,5,6,7,8,9,10,11,12],function(k){
                            console.log(this.data[i][k])
                            totalTr.append("<td ignore style=\"text-align:right\"><span>"+k+"</span></td>")
                        },this)
                    }
                },this)
            },
            _formatValues:function()
            {
                this.cancelAsync(this._formatValuesJob)
                this._formatValuesJob = 
                    this.async(function()
                    {
                        const TDs = jQuery(
                            this.$.dataTable.querySelectorAll('* /deep/ td')).not('[ignore]');

                        this.async(function(){
                            _.each(TDs, function(td) {
                                var number = +(td.querySelector('span')
                                    .innerText
                                    .replace(",","")
                                    .replace('%',''));
                                if(number === 0) 
                                {
                                    td.querySelector('span').style.opacity = .4;
                                }
                                else
                                    td.querySelector('span').style.opacity = 1;

                            })
                        },100);
                        /*
                        this.async(function(){
                            _.each(TDs, function(td) {
                                var s = td.innerText.trim();
                                if (s.match(/^-?\d+\.?\d*$/)) {
                                   td.querySelector('span').innerText = 
                                                            parseFloat( td.innerText)
                                                            .formatMoney(this.formatAsInteger ? 0 : 2);
                                }
                            },this)
                        },10);
                        */

                    },1);
              
            },
            _dataDimensionsObserver: function() {
                if(this.filter)
                    this.filterByDimensionsList();
            },
            _pathChanged: function() {
                this.$.dataTable.progress = true;
                //this.dimensions = [];
                this._path = this.path.replace(/(\s+|\.)/g, '-');
                this.async(this._removeFilters, 1000)
            },
            _pathDBObserver: function(_path, db) {
                this.data = [];
                var URL = FB_URL + "/" + this._path + "/" + this.db;
                if (this.FBRef)
                    this.FBRef.off();
                this.FBRef = new Firebase(URL);
                this.FBRef.on('value', function(dataSnap) {
                    var V = dataSnap.val();
                    var A = this.dimensions;
                    var B = _.keys(V);
                    var DiffAB = _.difference(A, B)
                    var isEmpty = _.isEmpty(DiffAB);
                    //console.log(URL, V);
                    if (!isEmpty) {
                        var ListData = this._getListedData(V);
                        _.each(DiffAB, function(d) {
                            ListData.push({
                                dimension: d,
                                1:  this.fillValue,
                                2:  this.fillValue,
                                3:  this.fillValue,
                                4:  this.fillValue,
                                5:  this.fillValue,
                                6:  this.fillValue,
                                7:  this.fillValue,
                                8:  this.fillValue,
                                9:  this.fillValue,
                                10: this.fillValue,
                                11: this.fillValue,
                                12: this.fillValue
                            })
                        }
                        .bind(this))
                        this.data = ListData;
                    }

                    if (!_.isEmpty(V)) {
                        this.data = this._getListedData(V);
                    }
                    
                    //console.log(URL, this.data);
                    this.$.dataTable.progress = false;
                }
                .bind(this));
            },
            _buildDB: function() {
                
                this.cancelAsync(this._buildDBJOB)
                this._buildDBJOB = 
                    this.async(function()
                    {
                       if (!this._path)
                            return;
                        var Obj = this._getStructuredData(this.data);
                        if (this.meta && this.metaEditable)
                            _.each(Obj, function(obj) {
                                if (!obj.meta)
                                    obj.meta = 100;
                            })
                        this._save(Obj);

                    },1)

                
            },
            _save: function(Obj) {
                if(_.isEmpty(Obj))
                    return;
                try {
                    new Firebase(FB_URL + "/" + this._path + "/" + this.db).set(Obj);
                    this.fire('tabela-mes-build');

                    this._formatValues();
                }
                catch(e){
                    // var X = _.chain(Obj)
                    // .values()
                    // .map(function(x){return _.values(x)})
                    // .flatten()
                    // .filter(function(x){return _.isNumber(x) })
                    // .uniq()
                    // .first()
                    // .value()
                    // if(_.isNaN(X))
                    //     console.log('NaN error')
                }
            },
            _getStructuredData: function(D) {
                
                //const K = JSON.stringify(D);
                
                //if(STRUCTURED_CACHE[K])
                    //return STRUCTURED_CACHE[K];

                const S = _.mapObject(_.groupBy(D, 'dimension'), function(x) {
                    f = _.first(x);
                    var F = parseFloat;
                    f['1'] =    F(f['1'])   && F(F(f['1'])  .toFixed(10));
                    f['2'] =    F(f['2'])   && F(F(f['2'])  .toFixed(10));
                    f['3'] =    F(f['3'])   && F(F(f['3'])  .toFixed(10));
                    f['4'] =    F(f['4'])   && F(F(f['4'])  .toFixed(10));
                    f['5'] =    F(f['5'])   && F(F(f['5'])  .toFixed(10));
                    f['6'] =    F(f['6'])   && F(F(f['6'])  .toFixed(10));
                    f['7'] =    F(f['7'])   && F(F(f['7'])  .toFixed(10));
                    f['8'] =    F(f['8'])   && F(F(f['8'])  .toFixed(10));
                    f['9'] =    F(f['9'])   && F(F(f['9'])  .toFixed(10));
                    f['10'] =   F(f['10'])  && F(F(f['10']) .toFixed(10));
                    f['11'] =   F(f['11'])  && F(F(f['11']) .toFixed(10));
                    f['12'] =   F(f['12'])  && F(F(f['12']) .toFixed(10));
                    
                    f['dimension'] = f['dimension']
                        .replace(/^([qQ]uantidade|[qQ]uatidade|[qQ]td|qntd)/,"Qntd")
                        .replace(/^(preço|pre|price|pr)/,"Preço")
                        .replace(/:(\w+)/,": $1")

                    return f;
                }
                .bind(this));

                //window.STRUCTURED_CACHE[ K ] = S;

                return S;
            },
            getStructuredDataAsPercent: function() {
                var D = JSON.parse(JSON.stringify(this.data) || '{}');
                return _.mapObject(_.groupBy(D, 'dimension'), function(x) {
                    f = _.first(x);
                    var F = parseFloat;
                    f['1'] = 1 + F(F(f['1']) && F(F(f['1']).toFixed(2))) / 100;
                    f['2'] = 1 + F(F(f['2']) && F(F(f['2']).toFixed(2))) / 100;
                    f['3'] = 1 + F(F(f['3']) && F(F(f['3']).toFixed(2))) / 100;
                    f['4'] = 1 + F(F(f['4']) && F(F(f['4']).toFixed(2))) / 100;
                    f['5'] = 1 + F(F(f['5']) && F(F(f['5']).toFixed(2))) / 100;
                    f['6'] = 1 + F(F(f['6']) && F(F(f['6']).toFixed(2))) / 100;
                    f['7'] = 1 + F(F(f['7']) && F(F(f['7']).toFixed(2))) / 100;
                    f['8'] = 1 + F(F(f['8']) && F(F(f['8']).toFixed(2))) / 100;
                    f['9'] = 1 + F(F(f['9']) && F(F(f['9']).toFixed(2))) / 100;
                    f['10'] = 1 + F(F(f['10']) && F(F(f['10']).toFixed(2))) / 100;
                    f['11'] = 1 + F(F(f['11']) && F(F(f['11']).toFixed(2))) / 100;
                    f['12'] = 1 + F(F(f['12']) && F(F(f['12']).toFixed(2))) / 100;


                    return f;
                });
            },
            _getListedData: function(D) {
                return _.sortBy(_.values(D), function(d) 
                {
                	if(this.sortMap && this.sortMap[d.dimension]){
                        const X = this.sortMap[d.dimension];
                		return X.replace ? X.replace(/(Preço:|Qntd:)/,"") : X;
                    }
                    S = ((_.indexOf(d.dimension,'-') > 0 ? 
                            parseInt(d.dimension.split('-')[0]) 
                            : d.dimension))
                    return S.replace ? S.replace(/(Preço:|Qntd:)/,"") : S;
                },this)
            },
            putStrucureData:function(D){
                this.data = this._getListedData(D);
            },
            _setSampleData: function() {
                console.log('_setSampleData')
                var Interval = setInterval(function() {
                    if (_.isEmpty(this.dimensions))
                        return;
                    var D = this.getSampleData(this.fillValue);
                    this.data = D;
                    this._buildDB();
                    clearInterval(Interval);
                }
                .bind(this), 1)
            },
            /* public */
            getSampleData: function(value, options) {
                options = options || {};
                var D = [];
                _.each(this.dimensions, function(d) {
                    var Obj = {
                        dimension: d,
                        1:  value,
                        2:  value,
                        3:  value,
                        4:  value,
                        5:  value,
                        6:  value,
                        7:  value,
                        8:  value,
                        9:  value,
                        10: value,
                        11: value,
                        12: value
                    }
                    D.push(Obj)
                }
                .bind(this))
                return options.isStructured ? this._getStructuredData(D) : D;
            },
            getStructuredData: function(options) {
                return this._getStructuredData(this.data, options);
            },
            productABC: function(A, B, C, D, options) {
                console.log('productABC')
                options = options || {
                    tax: 1
                }
                var Y = {};
                _.each(A, function(vA, kA) {
                    _.each(B, function(vB, kB) {
                        _.each(C, function(vC, kC) {
                            _.each(D, function(vD, kD) {
                                if (kA == kB && kB == kC && kC == kD) {
                                    Y[kA] = {
                                        1:  vA['1'] * vB['1'] * vC['1'] * vD['1'] * options.tax,
                                        2:  vA['2'] * vB['2'] * vC['2'] * vD['2'] * options.tax,
                                        3:  vA['3'] * vB['3'] * vC['3'] * vD['3'] * options.tax,
                                        4:  vA['4'] * vB['4'] * vC['4'] * vD['4'] * options.tax,
                                        5:  vA['5'] * vB['5'] * vC['5'] * vD['5'] * options.tax,
                                        6:  vA['6'] * vB['6'] * vC['6'] * vD['6'] * options.tax,
                                        7:  vA['7'] * vB['7'] * vC['7'] * vD['7'] * options.tax,
                                        8:  vA['8'] * vB['8'] * vC['8'] * vD['8'] * options.tax,
                                        9:  vA['9'] * vB['9'] * vC['9'] * vD['9'] * options.tax,
                                        10: vA['10'] * vB['10'] * vC['10'] * vD['10'] * options.tax,
                                        11: vA['11'] * vB['11'] * vC['11'] * vD['11'] * options.tax,
                                        12: vA['12'] * vB['12'] * vC['12'] * vD['12'] * options.tax,
                                        dimension: vA.dimension
                                    }
                                }
                            });
                        })
                    })
                })
                this.data = this._getListedData(Y);
                this._buildDB();
            },
            productAB:function(A,B,options){
                options = options || {
                    tax: 1
                }
                var Y = {};
                _.each(A, function(vA, kA) {
                    _.each(B, function(vB, kB) 
                    {  
                        if (kA == kB) {
                            Y[kA] = {
                                1:  vA['1'] * vB['1']       * options.tax,
                                2:  vA['2'] * vB['2']       * options.tax,
                                3:  vA['3'] * vB['3']       * options.tax,
                                4:  vA['4'] * vB['4']       * options.tax,
                                5:  vA['5'] * vB['5']       * options.tax,
                                6:  vA['6'] * vB['6']       * options.tax,
                                7:  vA['7'] * vB['7']       * options.tax,
                                8:  vA['8'] * vB['8']       * options.tax,
                                9:  vA['9'] * vB['9']       * options.tax,
                                10: vA['10'] * vB['10']     * options.tax,
                                11: vA['11'] * vB['11']     * options.tax,
                                12: vA['12'] * vB['12']     * options.tax,
                                dimension: vA.dimension
                            }
                        }
                    })
                })
                this.data = this._getListedData(Y);
                this._buildDB();
            },
            fill: function(table, usingMensure) {
                this.dimensions = _.keys(table);
                var S = 0;
                if (_.isEmpty(this.dimensions)) {
                   // console.log('fill-failed')
                    return this.fire('fill-failed')
                }
                var M = _.mapObject(table, function(r, k) {
                    
                    S += r[usingMensure];

                    return {
                        1:  r[usingMensure],
                        2:  r[usingMensure],
                        3:  r[usingMensure],
                        4:  r[usingMensure],
                        5:  r[usingMensure],
                        6:  r[usingMensure],
                        7:  r[usingMensure],
                        8:  r[usingMensure],
                        9:  r[usingMensure],
                        10: r[usingMensure],
                        11: r[usingMensure],
                        12: r[usingMensure],
                        dimension: k
                    }
                });
                this.async(function() {
                    this._save(M);
                }, 1000)

                return S;
            },
            put: function(mesesObject, options) {
                if (_.size(mesesObject) < 12)
                    return 1;
                _.each(this.data, function(d) {
                    if (_(options.ifDimIs).contains(d.dimension)) {
                        _.each([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], function(m) {
                            if (d.meta === undefined)
                                d.meta = 100;
                            if (!options.Tax.useMeta)
                                d.meta = options.Tax[d.dimension]
                            d.meta = parseFloat(d.meta);
                            d[m] = mesesObject[m] * d.meta
                            d[m] = parseFloat(d[m] * (1 / 100))
                            if (_.isNaN(d[m]))
                                console.warn('d[m]='+d[m]) ;
                        })
                    }
                }, this)
            },
            filterByDimensionsList: function(currentFaixaDWT,dimensions) {
                var f;
                if(!currentFaixaDWT) 
                {
                    var F = document.querySelector("* /deep/ #filterContainer /deep/ " + this.filter);
                    if (!F)
                        return;
                    f = F.value;
                }
                else {
                    f = currentFaixaDWT;
                }              
                var D = f == "Todos" ? (dimensions || this.dimensions) : [f];
                _.each(this.querySelectorAll('* /deep/ [data-key]'), function(tr) {
                    tr.style.display = "table-row";
                    var tdText = tr.querySelector('td').innerText.trim()
                    if (!_.contains(D, tdText))
                        tr.style.display = "none";
                });
            },
            _addDimension:function(d)
            {
                if(!_.contains(this.dimensions,d)) 
                {
                    this.dimensions.push(d);
                    this.data.push({
                            dimension: d,
                            1:  0,
                            2:  0,
                            3:  0,
                            4:  0,
                            5:  0,
                            6:  0,
                            7:  0,
                            8:  0,
                            9:  0,
                            10: 0,
                            11: 0,
                            12: 0
                        })
                }
                _.each(this.data,function(d){
                    if(d.dimension == 'Total')
                       d.dimension = '? ? ? ?'
                })
                this._dataChanged();
            },
            _addDim1:function(){
                if(!this._dimensionLabel){
                    alert("Insira algum valor!")
                    return;
                }
                this._addDimension(this._dimensionLabel)
                this._dimensionLabel = "";
            },
            _addDim2:function(){
                if(!this._dimensionLabel){
                    alert("Insira algum valor!")
                    return;
                }
                this._addDimension('Preço: '+this._dimensionLabel);
                this._addDimension('Qntd: '+this._dimensionLabel);
                this._dimensionLabel = "";
            },
            _removeFilters: function() {
                _.each(this.querySelectorAll('* /deep/ [data-key]'), function(tr) {
                    tr.style.display = "table-row";
                });
            }
        });
    </script>
</dom-module>
