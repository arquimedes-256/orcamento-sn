
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<dom-module id="sn-tabela-mes">
	<template>
		<style>
		:host {
			display: block;
		}
         h4 {
		    margin: 0px;
		    margin-top: 10px;
		    position: relative;
		    top: 4px;
		    left: 22px;
		    padding-top: 7px;
		    font-size: 14px;
		}
		paper-datatable /deep/ td.bound-cell div span {
		    flex: 1;
		    font-size: 11px;
		}
		</style>

			<h4>{{header}}</h4>
			 <paper-datatable data="{{data}}" id="dataTable">

	          <paper-datatable-column 
	            header="#" 
	            property="dimension" 
	            align="left" 
	            tooltip=""></paper-datatable-column>

	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Jan" 
	            property="1" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Fev" 
	            property="2" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Mar" 
	            property="3" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Abr" 
	            property="4" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Mai" 
	            property="5" 
	            align="right" 
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Jun" 
	            property="6" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Jul" 
	            property="7" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Ago" 
	            property="8" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Set" 
	            property="9" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Out" 
	            property="10" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Nov" 
	            property="11" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Dez" 
	            property="12" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	        </paper-datatable>
	        <paper-progress indeterminate></paper-progress>  
	</template>
	<script>
		Polymer({
			is: 'sn-tabela-mes',
			properties:{
				header:{type:String,value:"Header"},
				data:{
					value:[]
				},
				db:{
					observers:'_buildDB',type:String
				},
				editable:{type:Boolean,value:false},
				path:{type:String,observer:'_pathChanged'},
				virtual:{type:Boolean},
				dimensions:{type:Array},
				filter:{type:String}
			},
			observers:['_pathDBObserver(_path,db)','_dataDimensionsObserver(data,dimensions)'],
			ready:function() {
				this.addEventListener('keydown',this._changeHandler);
			},
			_changeHandler:function() {
				this._buildDB();
			},
			_dataDimensionsObserver:function(){
				
			},
			_pathChanged:function(){
				this.dimensions = [];
				this._path = this.path.replace(/\s+/g,'-');
			},
			_pathDBObserver:function(_path,db){
				this.data = [];
				new Firebase(FB_URL+"/"+this._path+"/"+this.db)
					.on('value',function(dataSnap){

						this.async(function()
						{

							var V = dataSnap.val();
							var A = this.dimensions;
							var B =  _.keys(V);
							var DiffAB = _.difference(  A , B )
							var isEmpty = _.isEmpty(DiffAB);

							if(!isEmpty)
							{
								var ListData = this._getListedData(V);
								_.each(DiffAB,function(d){
									ListData.push({
										dimension:d,
										1	:0,
										2	:0,
										3	:0,
										4	:0,
										5	:0,
										6	:0,
										7	:0,
										8	:0,
										9	:0,
										10	:0,
										11	:0,
										12	:0
									})
								})
								this.data = ListData;
							}
							else if(!_.isEmpty(V)) {
								this.data = this._getListedData(V);
							}
							else
							{
								this._setSampleData();
							}
							this.fire('tabela-mes-build')
						},1000)

					}.bind(this));
				

			},
			_buildDB:function(){
				if(!this._path){console.warn('path is null');return;}

				var Obj = this._getStructuredData(this.data);

				this._save(Obj);				
			},
			_save:function(Obj) {
				new Firebase(FB_URL+"/"+this._path+"/"+this.db)
					.update(Obj);
			},
			_getStructuredData:function(D) {
				return _.mapObject(_.groupBy(D,'dimension'),function(x){
					f = _.first(x);
					
					f['1']  = f['1'] |0;	
					f['2']  = f['2'] |0;
					f['3']  = f['3'] |0;
					f['4']  = f['4'] |0;
					f['5']  = f['5'] |0;
					f['6']  = f['6'] |0;
					f['7']  = f['7'] |0;
					f['8']  = f['8'] |0;
					f['9']  = f['9'] |0;
					f['10'] = f['10']|0;
					f['11'] = f['11']|0;
					f['12'] = f['12']|0;

					return f;
				});
			},
			_getListedData:function(D){
				return _.sortBy(_.values(D),function(d){ 

					return parseInt(d.dimension.split('-')[0]) });
			},
			_setSampleData:function(){
				var D 	= [];
				_.each(this.dimensions,function(d){
					D.push({
							dimension:d,
							1	:0,
							2	:0,
							3	:0,
							4	:0,
							5	:0,
							6	:0,
							7	:0,
							8	:0,
							9	:0,
							10	:0,
							11	:0,
							12	:0
						})
				}.bind(this))
				this.data = D;
				this._buildDB();
			},
			/* public */
			getStructuredData:function(){
				return this._getStructuredData(this.data);
			},
			productABC:function(A,B,C){
				var Y = {};
		      	_.each(A,function(vA,kA){
		      		_.each(B,function(vB,kB){
		      			_.each(C,function(vC,kC){
		      				if(kA == kB && kB == kC) {
		      					Y[kA] = {
		      						1 : 	vA['1'] 	*vB['1'] 	*vC['1'] ,
		      						2 : 	vA['2'] 	*vB['2'] 	*vC['2'] ,
		      						3 : 	vA['3'] 	*vB['3'] 	*vC['3'] ,
		      						4 : 	vA['4'] 	*vB['4'] 	*vC['4'] ,
		      						5 : 	vA['5'] 	*vB['5'] 	*vC['5'] ,
		      						6 : 	vA['6'] 	*vB['6'] 	*vC['6'] ,
		      						7 : 	vA['7'] 	*vB['7'] 	*vC['7'] ,
		      						8 : 	vA['8'] 	*vB['8'] 	*vC['8'] ,
		      						9 : 	vA['9'] 	*vB['9'] 	*vC['9'] ,
		      						10: 	vA['10'] 	*vB['10'] 	*vC['10'],
		      						11: 	vA['11'] 	*vB['11'] 	*vC['11'],
		      						12: 	vA['12'] 	*vB['12'] 	*vC['12'], 
		      						dimension: vA.dimension
		      					}
		      				}
		      			})
		      		})
		      	})
		      	this.data = this._getListedData(Y);
		      	this._buildDB();
			},
			fill:function(table,usingMensure){
				this.async(function(){
					var M = _.mapObject(table,function(r,k){ 
						return {
	      						1 : 	r[usingMensure],
	      						2 : 	r[usingMensure],
	      						3 : 	r[usingMensure],
	      						4 : 	r[usingMensure],
	      						5 : 	r[usingMensure],
	      						6 : 	r[usingMensure],
	      						7 : 	r[usingMensure],
	      						8 : 	r[usingMensure],
	      						9 : 	r[usingMensure],
	      						10: 	r[usingMensure],
	      						11: 	r[usingMensure],
	      						12: 	r[usingMensure],
	      						dimension: k
	      					}
					});
					this._save(M);
				},5000)
			},

			filterByDimensionsList:function() {
					var f = document.querySelector("* /deep/ #filterContainer /deep/ "+this.filter).value;
					var D = f == "Todos" ? this.dimensions : [f];

					_.each(this.querySelectorAll('* /deep/ [data-key]'),function(tr) {
						tr.style.display = "table-row";
						var tdText = tr.querySelector('td').innerText.trim()
						if(!_.contains(D,tdText))
							tr.style.display = "none";
					});
			},

		});
	</script>
</dom-module>