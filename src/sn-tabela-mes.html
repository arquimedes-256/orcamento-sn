
<dom-module id="sn-tabela-mes">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>
		<h4 style="margin: 0px;margin-top: 10px;">{{header}}</h4>
		 <paper-datatable data="{{data}}" id="dataTable" on-change="_changeHandler">

          <paper-datatable-column 
            header="#" 
            property="dimension" 
            align="left" 
            tooltip=""></paper-datatable-column>

          <paper-datatable-column editable dialog type="Number"
            header="Jan" 
            property="1" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Fev" 
            property="2" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Mar" 
            property="3" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Abr" 
            property="4" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Mai" 
            property="5" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Jun" 
            property="6" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Jul" 
            property="7" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Ago" 
            property="8" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Set" 
            property="9" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Out" 
            property="10" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Nov" 
            property="11" 
            align="right" 
            tooltip=""></paper-datatable-column>
          <paper-datatable-column editable dialog type="Number"
            header="Dez" 
            property="12" 
            align="right" 
            tooltip=""></paper-datatable-column>
        </paper-datatable>  
	</template>
	<script>
		Polymer({
			is: 'sn-tabela-mes',
			properties:{
				header:{type:String,value:"Header"},
				data:{
					value:[]
				},
				dimensions:{
					observer:'_buildDimension'
				},
				db:{
					observers:'_buildDB',type:String
				},
				path:{type:String},
			},
			_buildDimension:function(){
				console.log('_buildDimension',this.data);

				if(_.isEmpty(this.data))
					new Firebase(FB_URL+"/"+this.path+"/"+this.db)
						.on('value',function(dataSnap){
							var V = dataSnap.val();
							if(V) {
								this.data = this._getListedData(V);
							}
							else
							{
								this._setSampleData();
							}

						}.bind(this));
					
				this.filterByDimensionsList();

			},
			_buildDB:function(){
				console.log('_buildDB');

				if(!this.path){console.warn('path is null');return;}

				var Obj = this._getStructuredData(this.data);

				new Firebase(FB_URL+"/"+this.path+"/"+this.db).update(Obj);
				this.fire('tabela-mes-build')
			},
			_changeHandler:function() {
				this._buildDB();
			},
			_getStructuredData:function(D) {
				return _.mapObject(_.groupBy(D,'dimension'),function(x){return _.first(x)});
			},
			_getListedData:function(D){
				return _.values(D);
			},
			_setSampleData:function(){
				var D 	= [];
				_.each(this.dimensions,function(d){
					D.push({
							dimension:d,
							1	:0,
							2	:0,
							3	:0,
							4	:0,
							5	:0,
							6	:0,
							7	:0,
							8	:0,
							9	:0,
							10	:0,
							11	:0,
							12	:0
						})
				}.bind(this))
				this.data = D;
				this._buildDB();
			},
			/* public */
			getStructuredData:function(){
				return this._getStructuredData(this.data);
			},
			productABC:function(A,B,C){
				var Y = {};
		      	_.each(A,function(vA,kA){
		      		_.each(B,function(vB,kB){
		      			_.each(C,function(vC,kC){
		      				if(kA == kB && kB == kC) {
		      					Y[kA] = {
		      						1 : 	vA['1'] 	*vB['1'] 	*vC['1'] ,
		      						2 : 	vA['2'] 	*vB['2'] 	*vC['2'] ,
		      						3 : 	vA['3'] 	*vB['3'] 	*vC['3'] ,
		      						4 : 	vA['4'] 	*vB['4'] 	*vC['4'] ,
		      						5 : 	vA['5'] 	*vB['5'] 	*vC['5'] ,
		      						6 : 	vA['6'] 	*vB['6'] 	*vC['6'] ,
		      						7 : 	vA['7'] 	*vB['7'] 	*vC['7'] ,
		      						8 : 	vA['8'] 	*vB['8'] 	*vC['8'] ,
		      						9 : 	vA['9'] 	*vB['9'] 	*vC['9'] ,
		      						10: 	vA['10'] 	*vB['10'] 	*vC['10'],
		      						11: 	vA['11'] 	*vB['11'] 	*vC['11'],
		      						12: 	vA['12'] 	*vB['12'] 	*vC['12'], 
		      						dimension: vA.dimension
		      					}
		      				}
		      			})
		      		})
		      	})
		      	this.data = this._getListedData(Y);
		      	this._buildDB();
			},
			filterByDimensionsList:function() {
				var D = this.dimensions;
				_.each(this.querySelectorAll('* /deep/ [data-key]'),function(tr) {
					tr.style.display = "table-row";
					var tdText = tr.querySelector('td').innerText.trim()
					console.log(tdText)
					if(!_.contains(D,tdText))
						tr.style.display = "none";
				});
			}
		});
	</script>
</dom-module>