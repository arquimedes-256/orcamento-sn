
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<dom-module id="sn-tabela-mes">
	<template>
		<style>
		:host {
			display: block;
		}
         h4 {
		    margin: 0px;
		    margin-top: 10px;
		    position: relative;
		    top: 4px;
		    left: 22px;
		    padding-top: 7px;
		    font-size: 14px;
		}
		paper-datatable /deep/ td.bound-cell div span {
		    flex: 1;
		    font-size: 11px;
		}
		</style>

			<h4>{{header}}</h4>
			 <paper-datatable data="{{data}}" id="dataTable">

	          <paper-datatable-column 
	            header="#" 
	            property="dimension" 
	            align="left" 
	            tooltip=""></paper-datatable-column>

	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Jan" 
	            property="1" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Fev" 
	            property="2" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Mar" 
	            property="3" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Abr" 
	            property="4" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Mai" 
	            property="5" 
	            align="right" 
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Jun" 
	            property="6" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Jul" 
	            property="7" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Ago" 
	            property="8" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Set" 
	            property="9" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Out" 
	            property="10" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Nov" 
	            property="11" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	          <paper-datatable-column editable='{{editable}}' dialog='{{editable}}' type="Number"
	            header="Dez" 
	            property="12" 
	            align="right" default="0"
	            tooltip=""></paper-datatable-column>
	        </paper-datatable>
	        <template is="dom-if" if="{{_dataIsEmpty(data)}}">
	        	<paper-progress indeterminate style="width:100%"></paper-progress>  
	        </template>
	        <!--
	        <style>
	        paper-progress {
	        	--paper-progress-secondary-color:#D50000;
	        	--paper-progress-active-color: #FF1744;
	        }
	        </style>
	    -->
	</template>
	<script>
		Polymer({
			is: 'sn-tabela-mes',
			properties:{
				header:{type:String,value:"Header"},
				data:{
					value:[]
				},
				db:{
					observers:'_buildDB',type:String
				},
				editable:{type:Boolean,value:false},
				path:{type:String,observer:'_pathChanged'},
				virtual:{type:Boolean},
				dimensions:{type:Array},
				filter:{type:String},
				fillValue:{type:Number,value:0},
				fillForward:{type:Boolean,value:false}
			},
			observers:['_pathDBObserver(_path,db)','_dataDimensionsObserver(data,dimensions)'],
			ready:function() {
				this.addEventListener('data-changed',this._changeHandler);
			},
			_dataIsEmpty:function(data){ return _.isEmpty(data) },
			_changeHandler:function() {
				this._buildDB();
			},
			_dataDimensionsObserver:function(){
				this._removeFilters();
				this.filterByDimensionsList();
			},
			_pathChanged:function(){
				this.$.dataTable.progress = true;

				this._removeFilters();
				this.dimensions = [];
				this._path = this.path.replace(/\s+/g,'-');
			},
			_pathDBObserver:function(_path,db){
				this.data = [];
				var URL = FB_URL+"/"+this._path+"/"+this.db;

				if(this.FBRef)
					this.FBRef.off();

				this.FBRef = new Firebase(URL);
				this.FBRef.on('value',function(dataSnap){

						this.async(function()
						{
							var V = dataSnap.val();
							var A = this.dimensions;
							var B =  _.keys(V);
							var DiffAB = _.difference(  A , B )
							var isEmpty = _.isEmpty(DiffAB);

							console.log(URL,V);

							if(!isEmpty)
							{
								var ListData = this._getListedData(V);
								_.each(DiffAB,function(d){
									ListData.push({
										dimension:d,
										1	:this.fillValue,
										2	:this.fillValue,
										3	:this.fillValue,
										4	:this.fillValue,
										5	:this.fillValue,
										6	:this.fillValue,
										7	:this.fillValue,
										8	:this.fillValue,
										9	:this.fillValue,
										10	:this.fillValue,
										11	:this.fillValue,
										12	:this.fillValue
									})
								}.bind(this))
								this.data = ListData;
							}
							

							if(!_.isEmpty(V)) {
								this.data = this._getListedData(V);
							}
							if(_.isEmpty(this.data)) {
								this.async(this._setSampleData,333)
							}
							console.log(URL,this.data);
							this.$.dataTable.progress = false;

						},333)

					}.bind(this));
				

			},
			_buildDB:function(){
				if(!this._path){console.warn('path is null');return;}

				var Obj = this._getStructuredData(this.data);

				this._save(Obj);				
			},
			_save:function(Obj) {
				new Firebase(FB_URL+"/"+this._path+"/"+this.db)
					.update(Obj);
				
				this.fire('tabela-mes-build');
				
			},
			_getStructuredData:function(D) {
				return _.mapObject(_.groupBy(D,'dimension'),function(x){
					f = _.first(x);
					
					f['1']  = parseFloat(f['1'] ) && parseFloat(f['1'] ).toFixed(2);	
					f['2']  = parseFloat(f['2'] ) && parseFloat(f['2'] ).toFixed(2);
					f['3']  = parseFloat(f['3'] ) && parseFloat(f['3'] ).toFixed(2);
					f['4']  = parseFloat(f['4'] ) && parseFloat(f['4'] ).toFixed(2);
					f['5']  = parseFloat(f['5'] ) && parseFloat(f['5'] ).toFixed(2);
					f['6']  = parseFloat(f['6'] ) && parseFloat(f['6'] ).toFixed(2);
					f['7']  = parseFloat(f['7'] ) && parseFloat(f['7'] ).toFixed(2);
					f['8']  = parseFloat(f['8'] ) && parseFloat(f['8'] ).toFixed(2);
					f['9']  = parseFloat(f['9'] ) && parseFloat(f['9'] ).toFixed(2);
					f['10'] = parseFloat(f['10']) && parseFloat(f['10']).toFixed(2);
					f['11'] = parseFloat(f['11']) && parseFloat(f['11']).toFixed(2);
					f['12'] = parseFloat(f['12']) && parseFloat(f['12']).toFixed(2);

					return f;
				});
			},
			_getListedData:function(D){
				return _.sortBy(_.values(D),function(d){ 

					return parseInt(d.dimension.split('-')[0]) });
			},
			_setSampleData:function(){
				
				var Interval = setInterval(function(){

						if(_.isEmpty(this.dimensions))
							return;
						var D 	= this.getSampleData(this.fillValue);
						this.data = D;
						this._buildDB();
						clearInterval(Interval);

				}.bind(this),300)

				
			},
			/* public */
			getSampleData:function(value,options){
				options = options || {};
				var D 	= [];
				_.each(this.dimensions,function(d){
					D.push({
							dimension:d,
							1	:value,
							2	:value,
							3	:value,
							4	:value,
							5	:value,
							6	:value,
							7	:value,
							8	:value,
							9	:value,
							10	:value,
							11	:value,
							12	:value
						})
				}.bind(this))
				return options.isStructured ? this._getStructuredData(D) : D;
			},
			getStructuredData:function(options){
				return this._getStructuredData(this.data,options);
			},
			productABC:function(A,B,C,D,options){
				options = options || {tax:1}
				var Y = {};
		      	_.each(A,function(vA,kA){
		      		_.each(B,function(vB,kB){
		      			_.each(C,function(vC,kC){
			      			_.each(D,function(vD,kD){

			      				if(kA == kB && kB == kC && kC == kD) {
			      					Y[kA] = {
			      						1 : 	vA['1'] 	*vB['1'] 	*vC['1']  *vD['1']  * options.tax,
			      						2 : 	vA['2'] 	*vB['2'] 	*vC['2']  *vD['2']  * options.tax,
			      						3 : 	vA['3'] 	*vB['3'] 	*vC['3']  *vD['3']  * options.tax,
			      						4 : 	vA['4'] 	*vB['4'] 	*vC['4']  *vD['4']  * options.tax,
			      						5 : 	vA['5'] 	*vB['5'] 	*vC['5']  *vD['5']  * options.tax,
			      						6 : 	vA['6'] 	*vB['6'] 	*vC['6']  *vD['6']  * options.tax,
			      						7 : 	vA['7'] 	*vB['7'] 	*vC['7']  *vD['7']  * options.tax,
			      						8 : 	vA['8'] 	*vB['8'] 	*vC['8']  *vD['8']  * options.tax,
			      						9 : 	vA['9'] 	*vB['9'] 	*vC['9']  *vD['9']  * options.tax,
			      						10: 	vA['10'] 	*vB['10'] 	*vC['10'] *vD['10'] * options.tax,
			      						11: 	vA['11'] 	*vB['11'] 	*vC['11'] *vD['11'] * options.tax,
			      						12: 	vA['12'] 	*vB['12'] 	*vC['12'] *vD['12'] * options.tax, 
			      						dimension: vA.dimension
			      					}
			      				}
			      			});
		      			})
		      		})
		      	})
		      	this.data = this._getListedData(Y);
		      	this._buildDB();
			},
			fill:function(table,usingMensure){
				this.dimensions = _.keys(table);
				if(_.isEmpty(this.dimensions)) {
					console.log('fill-failed')
					return this.fire('fill-failed')
				}
				this.async(function(){
					var M = _.mapObject(table,function(r,k){ 
						return {
	      						1 : 	r[usingMensure],
	      						2 : 	r[usingMensure],
	      						3 : 	r[usingMensure],
	      						4 : 	r[usingMensure],
	      						5 : 	r[usingMensure],
	      						6 : 	r[usingMensure],
	      						7 : 	r[usingMensure],
	      						8 : 	r[usingMensure],
	      						9 : 	r[usingMensure],
	      						10: 	r[usingMensure],
	      						11: 	r[usingMensure],
	      						12: 	r[usingMensure],
	      						dimension: k
	      					}
					});
					this._save(M);
				},333)
			},

			filterByDimensionsList:function() {
					var F = document.querySelector("* /deep/ #filterContainer /deep/ "+this.filter);
					if(!F) return;
					var f = F.value;
					var D = f == "Todos" ? this.dimensions : [f];

					_.each(this.querySelectorAll('* /deep/ [data-key]'),function(tr) {
						tr.style.display = "table-row";
						var tdText = tr.querySelector('td').innerText.trim()
						if(!_.contains(D,tdText))
							tr.style.display = "none";
					});
			},
			_removeFilters:function(){
				_.each(this.querySelectorAll('* /deep/ [data-key]'),function(tr) {
						tr.style.display = "table-row";
					});
			}

		});
	</script>
</dom-module>