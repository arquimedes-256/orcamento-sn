<link rel="import" href="sn-receita-bruta-novo-cliente.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">

<dom-module id="sn-receita-bruta-filters">
    <template>
    <style>
      :host {
        display: block;
      }

    paper-input[disabled] /deep/ * {
      opacity:1!important;
   
    }
    * /deep/ [contrato], * /deep/ [tarifa-fixa] {
        display:none!important;
    }

    </style>
      
      <sn-data-top id="dataTOP" 
            on-response-faixacontrato="_topFaixaContratoHandler"
            on-response-infocontrato="_topInfoContratoHandler">
         </sn-data-top>
      <sn-receita-bruta-novo-cliente id="novoClienteElement"></sn-receita-bruta-novo-cliente>
         <div class="layout horizontal">
            <h5 style="width: 134px;font-size: 14px;margin-right: 4px;color: #FFF;">Receita Bruta</h5>

          <style>
          #filial /deep/ paper-input ,  
          paper-dropdown-menu#filial {
              width: 60px !important;
              margin-right: 14px;
          }
          </style>
          <paper-dropdown-menu label="Filial" id="filial" style="width:50px">
            <paper-listbox class="dropdown-content" 
            id="filial" 
            selected="4" 
            id="filialListBox"
            on-iron-select="_onChangeFilter">
             <paper-item>RGD</paper-item>
             <paper-item>PNG</paper-item>
             <paper-item>STR</paper-item>
             <paper-item>SEP</paper-item>
             <paper-item>RJ1</paper-item>
             <paper-item>VIT</paper-item>
             <paper-item>SDR</paper-item>
             <paper-item>MAC</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          
          <paper-dropdown-menu label="Cliente" id="cliente" on-iron-select="_onChangeFilter">
           <paper-listbox class="dropdown-content" selected="0" 
           id="clienteListBox">
              <template is="dom-repeat" items="[[clientList]]">
                 <paper-item>
                    <span nome-cliente>{{ item.nome }}</span>
                    <span contrato>{{item.num_contrato}}</span>
                    <span tarifa-fixa>{{item.tarifaFixa}}</span>
                </paper-item>
              </template>

          </paper-listbox>
          </paper-dropdown-menu>

              <paper-dropdown-menu 
                label="Faixa DWT" 
                id="faixaDWT" 
                on-iron-select="_onChangeFilter">
                  <paper-listbox 
                    class="dropdown-content" 
                    selected="0" 
                    id="faixaDWTListBox" 
                    style="width: 92px;">
                      <paper-item>Todos</paper-item>
                      <template is="dom-repeat" items="{{faixaList}}">
                               <paper-item>{{ item }}</paper-item>
                            </template>
                  </paper-listbox>
              </paper-dropdown-menu>

              <paper-dropdown-menu 
                label="Terminal" 
                id="terminal" 
                on-iron-select="_onChangeFilter">
                  <paper-listbox 
                    class="dropdown-content" 
                    selected="0" 
                    id="terminalList" 
                    style="width: 92px;">
                      <template is="dom-repeat" items="{{terminalList}}">
                               <paper-item style="width: 172px;">{{ item }}</paper-item>
                            </template>
                  </paper-listbox>
              </paper-dropdown-menu>

    <style>
        #terminal /deep/ .dropdown-content {
            width: 219px;
        }
        
        #terminal /deep/ iron-dropdown {}
    </style>

    <paper-input label="Contrato" id="inputContrato" value="*" readonly></paper-input>
    <paper-input label="Tipo de Tarifa" id="inputTipoTarifa" value="*" readonly></paper-input>
    <paper-input label="Moeda" id="inputMoeda" value="*" readonly></paper-input>
    <paper-input label="Tarifa U$" id="inputCambio" value="3.25" readonly></paper-input>

    </div>
    </template>
    <script>
const TARIFA_PADRAO = 3.25;
Polymer({
	is: 'sn-receita-bruta-filters',
	properties: {

		faixaList: {
			type: Array
		},
		path: {
			type: String
		},
		selectedFaixas: {
			type: Array
		},
		selectedTerminal: {
			type: String
		},
		selectedCliente: {
			type: String,
			observer: '_selectedClienteChanged'
		},
		currentFilial: {
			type: String,
			observer: '_currentFilialChanged',
			value: null,
		},
		clientList: {
			type: Array,
			observer: '_clientListChanged',
			value: [{
				nome: "Saveiros",
				num_contrato: "RJ1000153",tarifaFixa:2.34
			}, {
				nome: "Camorim",
				num_contrato: "RJ1000158",tarifaFixa:2.34
			}, {
				nome: "Wallenius",
				num_contrato: "RJ1000590",tarifaFixa:2.34
			}, {
				nome: "Elcano",
				num_contrato: "RJ1000839"
			}, {
				nome: "Granel",
				num_contrato: "RGD000977"
			}, {
				nome: "Hamburgsud",
				num_contrato: "RGD000801"
			}, {
				nome: "BBC",
				num_contrato: "MAC000514"
			}, {
				nome: "BBC",
				num_contrato: "PNG000852"
			}, {
				nome: "Camorim",
				num_contrato: "SEP000309"
			}, {
				nome: "Oceanus",
				num_contrato: "SDR001140"
			}, {
				nome: "Cosco",
				num_contrato: "STR000675"
			}, {
				nome: "Elcano",
				num_contrato: "VIT000783"
			}]
		}
	},
	_currentFilialChanged: function() {
		this._filtraClientePorFilial();


		var ListBox = this.$.clienteListBox;
		

		new Firebase(FB_URL + "/clientes/" + this.currentFilial)
			.once("value", function(dataSnap) {
				$(ListBox.querySelectorAll('[remove-on-fetch-cliente]')).remove();
				var V = dataSnap.val();
				_.each(V, function(clienteV) {
					ListBox.innerHTML += 
					'<paper-item style="border-top:1px solid #E0E0E0" remove-on-fetch-cliente>'
					+ '<span nome-cliente>'+ clienteV.nome +'</span>'
					+ '</paper-item>';
				});
				ListBox.innerHTML += 
				'<paper-item style="border-top:1px solid #E0E0E0" remove-on-fetch-cliente>'
              +'<iron-icon '
              +'icon="social:person-add" '
             	+' style="position: relative;left: -5px;top: -1px;">'
              +'</iron-icon>Novo cliente</paper-item>';
			})
	},
	_selectedClienteChanged: function() {

		this.terminalList = [];
		this.selectedFaixas = [];
		this.faixaList = [];
		this.selectedTerminal = undefined;

		var num_contrato =
			_(this.clientList)
			.groupBy('nome')[this.selectedCliente][0]
			.num_contrato;
		this.$.inputContrato.value = num_contrato;

		this.$.dataTOP.getFaixasContrato(num_contrato, this._refreshFaixas);
		this.$.dataTOP.getInfoContrato(num_contrato);
	},
	observers: ['_buildPath(selectedCliente,selectedTerminal,currentFilial)'],
	ready: function() {

		setInterval(function() {
			if ((this.$.faixaDWT.innerText.trim() == "Todos" &&
					this.selectedTerminal === undefined)) {
				this.selectedTerminal = _.first(this.terminalList);
				this._refreshFaixas();
			}
		}.bind(this), 1000)

		this.currentFilial = "RJ1";
	},
	_buildPath: function() {
		if (this.selectedCliente && this.selectedTerminal)
			this.path = "receita/" +
			this.currentFilial +
			'/' +
			this.selectedCliente +
			'/' +
			this.selectedTerminal;

		this.fire('path-changed');
	},
	_onChangeFilter: function(e, d) {
		var filterId = e.path[11].id;
		var filterValue = d.item.innerText;
		var F = {
			faixaDWT: function() {

				_.each(document
					.querySelectorAll('* /deep/ sn-receita-bruta /deep/ sn-tabela-mes'),
					function(tabelaMesElement) {
						tabelaMesElement.filterByDimensionsList();
					})

			},
			cliente: function() {

				if (d.item.textContent.trim() == "Novo cliente") {

					this.async(function() {
						this.$.clienteListBox.selected = this.lastClientSelected | 0
						this.lastClientSelected = 0
						this.$.novoClienteElement.open();
						this._topFaixaContratoHandler();
					}, 333);

				} else {

					this.lastClientSelected = this.$.clienteListBox.selected;
					this.selectedCliente = d.item.querySelector('[nome-cliente]').innerText;
                    
                    var tarifaCliente = parseFloat(d.item.querySelector('[tarifa-fixa]').innerText);
                    this.$.inputCambio.value = tarifaCliente || TARIFA_PADRAO;
				}
			},
			terminal: function() {
				this.selectedTerminal = d.item.textContent;
				this._refreshFaixas();
			},
			filial: function() {
				this.currentFilial = filterValue;
				console.log('filtrando filial', this.currentFilial)
			}
		}

		F[filterId].bind(this)();

	},
	_filtraClientePorFilial: function() {
		this.async(function() {
			var itFiltred = false;
			//filtra filiais no comboBox
			_.each(this.$.clienteListBox.items, function(item, k) {
					if (!item.querySelector('[contrato]'))
						return;
					if (_.isEmpty(item.querySelector('[contrato]')
                            .innerText.match(this.currentFilial))) {
						item.hidden = true;
					} else {
						item.hidden = false;
						if (!itFiltred)
							this.$.clienteListBox.selected = k, itFiltred = true;
					}
				}
				.bind(this))
		}, 333)
	},
	_refreshFaixas: function() {

		if (!this.$.faixaDWTListBox)
			return;
		if (this.selectedTerminal === undefined)
			this.selectedTerminal = _.first(this.terminalList);
		//volta para faixa todos
		this.$.faixaDWTListBox.selected = 0;
		//fill
		if (this.selectedTerminal)
			this.fire('build-faixas', {
				faixasTarifa: this.$.dataTOP._terminalFaixasTarifa[this.selectedTerminal]
			})

		var TOP = this.$.dataTOP;
		this.selectedFaixas = this.faixaList =
			TOP.getFaixasByTerminal(this.selectedTerminal);

	},

	//TOPWEB responses
	_topFaixaContratoHandler: function() {
		this.terminalList = this.$.dataTOP.terminalList;
		this._refreshFaixas();
	},
	_topInfoContratoHandler: function(e, d) {
		this.$.inputMoeda.value = d.DESCRICAO_MOEDA;
		this.$.inputTipoTarifa.value = d.CD_TIPO_CONTRATO
	}

});
    </script>
</dom-module>