<link rel="import" href="sn-tabela-mes.html">
<link rel="import" href="sn-data-mxm.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">

<dom-module id="sn-tabela-contabil">
	<template>
		<style>
			:host {
				display: block;
         		padding: 14px;
			}
			paper-material {
				background:#FFF;
				padding:8px;
         	}
		</style>

		<div id="filters" class="layout horizontal">
			<h5 style="width: 181px;font-size: 14px;margin-right: 4px;color: #FFF;">
				{{grupoMasterLabel}}
			</h5>
			<paper-dropdown-menu label="Filial" id="filial">
		        <paper-listbox class="dropdown-content" 
		        selected="{{_currentFilial}}" 
		        attr-for-selected="name">
		             <paper-item name="RGD">RGD</paper-item>
		             <paper-item name="PNG">PNG</paper-item>
		             <paper-item name="STR">STR</paper-item>
		             <paper-item name="SEP">SEP</paper-item>
		             <paper-item name="RJ1">RJ1</paper-item>
		             <paper-item name="VIT">VIT</paper-item>
		             <paper-item name="SDR">SDR</paper-item>
		             <paper-item name="MAC">MAC</paper-item>
		        </paper-listbox>
		      </paper-dropdown-menu>

			<paper-dropdown-menu label="Grupo" id="grupo" droplarger>
		        <paper-listbox class="dropdown-content" 
		        selected="{{_currentGrupo}}" 
		        attr-for-selected="name">
		            <paper-item name="Todos">Todos</paper-item>
		    		<template is="dom-repeat" items="{{_grupoList}}">
		            	<paper-item name="[[item]]">[[item]]</paper-item>
		    		</template>
		        </paper-listbox>
		    </paper-dropdown-menu>
		</div>
		<paper-material>
	        <template is="dom-if" if="{{hasList(_contasList)}}">
	            <paper-progress indeterminate style="width:100%"></paper-progress>
	            Carregando...
	        </template>
	   

			 <template is="dom-repeat" items="{{_contasList}}">
		    	<sn-tabela-mes
		    		class="tabelaContaContabil"
		    		dim-editor='[[dimEditor]]'
		        	total
		        	total-bellow
		            db="valor" 
		            on-tabela-mes-build="_calcTotalTable"
		            path="{{_getPath(item)}}"
		            dimensions="[[_defaultDimensions]]"  
		            editable
		            header="[[item]]" 
		            header-font-size="12">
		     	</sn-tabela-mes>
		    </template>
		    

			<sn-tabela-mes
				id="tableTotal"
				total
			    total-bellow
			    db="total" 
			    path="{{_getGroupPath(_currentFilial)}}"
			    dimensions="{{_dimensionsTotal}}"
			    header="Total">
			</sn-tabela-mes>
		</paper-material>
		    

		<sn-data-mxm id="dataMXM" on-response-orcadorealizado="_onResponse"></sn-data-mxm>
	</template>
	<script>
		Polymer({
			is: 'sn-tabela-contabil',
			properties:{
				_currentFilial:{
					type:String,
					observer:'_render'
				},
				_currentGrupo:{
					value:"Todos",
					observer:'_filterGrupos'
				},
				idGrupoMaster:{
					type:Number,
					observer:'_render'
				},
				dimEditor:{
					type:Boolean,
					value:false
				},
				grupoMasterLabel:{

				},
				pathNamespace:{
					type:String
				},
				_defaultDimensions:{
					value:['Total']
				}
			},
			ready:function(){
				this._currentFilial = "RJ1";
				this._render();
			},
			_render:function(){
				this._contasList 	= [];
				this._grupoList		= [];
				this.$.dataMXM.getValuesSNAPP(this._currentFilial,this.idGrupoMaster)
			},
			_onResponse:function(e,d) {
				var V = d;
				var BijectionMap = this.BijectionMap = {};

				this._contasList 	= _.uniq(_.map(V,function(v){ 
					return v.idContaContabil + ': '+ST(v.nomeContaContabil)
				}))
				this._grupoList		= _.uniq(_.map(V,function(v){ return ST(v.grupo)  }))

				_.each(V,function(v){
					BijectionMap[v.idContaContabil] = ST(v.grupo)
				})
			},
			_filterGrupos:function() {
				var M = this.BijectionMap;
				var G = this._currentGrupo;
				var T = this.querySelectorAll('* /deep/ sn-tabela-mes:not(#tableTotal)')

				_.each(T,function(t){
					var k = _.first(t.header.match(/\d+/))

					if(G == "Todos" || M[k] == G)
						t.style.display = "block"
					else
						t.style.display = "none"
				})
			},
			_getGroupPath:function(){
				return [this.pathNamespace,this._currentFilial].join("/")
			},
			_getPath:function(item){
				return [this.pathNamespace,this._currentFilial,item].join("/")
			},
			hasList:function(){

				return this._contasList.length == 0;
			},
			_calcTotalTable:function() {
				var M 			= this.BijectionMap;
				var R 			= this.querySelectorAll('* /deep/ .tabelaContaContabil');
				var Rx 			= _.pluck(R,'totalDataPorMes');
				var Rh 			= _.map(_.pluck(R,'header'),function(x){return _.first(x.split(':'))});

				var G 			= this._grupoList;
				var SigmaList 	= _.map(G,function(g){return {dimension:ST(g)}})
				if(_.isEmpty(Rx))
					return;

				_.each(Rx,function(r,i){
					if(!r)
						return;
					_.each([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],function(k){
						_.each(SigmaList,function(Sigma){
							if(Sigma[k] === undefined)
								Sigma[k] = 0;
							if(M[Rh[i]] == Sigma.dimension)
								Sigma[k] += r[k]
						})
					})
				})
				this.$.tableTotal.data = SigmaList;
			}
		});
		function ST(x){ return x.replace(/(\.|#\[|\])/g,'').replace(/\//g,"\\") }
	</script>
</dom-module>