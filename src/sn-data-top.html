<!--
A comment describing this element

Example:

    <my-elem></my-elem>

Example:

    <my-elem>
      <h2>Hello my-elem</h2>
    </my-elem>

@demo demo/index.html
-->

<dom-module id="sn-data-top">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>
		<iron-ajax
		    auto
		    on-response="faixacontrato_responseHandler" id="ajaxFaixas" handle-as="json"></iron-ajax>
		<iron-ajax
		    auto
		    on-response="infocontrato_responseHandler" id="ajaxInfo" handle-as="json"></iron-ajax>
	</template>
	<script>
		Polymer({
			is: 'sn-data-top',
			
			faixacontrato_responseHandler:function(e,d,s){
				var V = e.detail.response;

				//remover faixas desnecessarias
				_.each(V,function($,k){

					if(V[k+1]
						&& V[k]['DESCRICAO_TERMINAL'] 	== V[k+1]['DESCRICAO_TERMINAL']
						&& V[k]['VLR_LINER'] 			== V[k+1]['VLR_LINER']
						&& V[k]['VLR_TRAMP'] 			== V[k+1]['VLR_TRAMP'] )
					{
						V[k+1]['DWT_INICIAL'] = V[k]['DWT_INICIAL']
						V[k] = null;
					}
				});
				V = _.difference(V,[null]);

				this.terminalList 		= _.uniq(_.map(V,function(x){ return x.DESCRICAO_TERMINAL}));
				this.faixaList 			= _.uniq(_.map(V,function(c){ return c.DWT_INICIAL + '-' + c.DWT_FINAL }));
				

				this._buildTerminalFaixasTarifasIndex(V);
				this.callBackFaixasContrato();
				this.fire('response-faixacontrato')
			},
			infocontrato_responseHandler:function(e,d,s){
				var R = _.first(e.detail.response);
				this.fire('response-infocontrato',R)
			},

			_buildTerminalFaixasTarifasIndex:function(response){
				var Y = {};
				var X = _.chain(response)
					.groupBy("DESCRICAO_TERMINAL").value();
				_.each(X,function(vX,terminalKey){
					if(!Y[terminalKey]) Y[terminalKey] = {};
					_.each(vX,function(v){
						v.VLR_LINER = parseFloat(v.VLR_LINER && v.VLR_LINER.replace(',','.'));
						v.VLR_TRAMP = parseFloat(v.VLR_TRAMP && v.VLR_TRAMP.replace(',','.'));

						Y[terminalKey][v.DWT_INICIAL+'-'+v.DWT_FINAL] = v;
					})
				})
				this._terminalFaixasTarifa = Y;
			},
			getFaixasContrato:function(num_contrato,callBackFaixasContrato) {
				this.$.ajaxFaixas.url = 
				"//www.topweb.sulnorte.com.br/top/xml/action/PRDAction.php?metodo=snorc_faixacontrato&num_contrato="+num_contrato;

				this.callBackFaixasContrato = callBackFaixasContrato;
			},
			getInfoContrato:function(num_contrato){
				this.$.ajaxInfo.url = 
				"//www.topweb.sulnorte.com.br/top/xml/action/PRDAction.php?metodo=snorc_infocontrato&num_contrato="+num_contrato;
			},
			getFaixasByTerminal:function(terminal) {
				if(this._terminalFaixasTarifa && terminal)
					return _.keys(this._terminalFaixasTarifa[terminal]);
			}
		});
	</script>
</dom-module>