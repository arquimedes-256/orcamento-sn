<!--
   @license
   Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
   This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
   The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
   The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
   Code distributed by Google as part of the polymer project is also
   subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
   -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="sn-tabela-mes.html">
<dom-module id="sn-view-detalhamento">
   <style is="custom-style" include="iron-flex"></style>
   <template>
      <style>
         :host {
         display: block;
         padding: 10px;
         }
         .card {
         box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
         padding: 16px;
         margin: 24px;
         border-radius: 5px;
         background-color: #fff;
         color: #757575;
         }
         .circle {
         display: inline-block;
         height: 64px;
         width: 64px;
         border-radius: 50%;
         background: #ddd;
         line-height: 64px;
         font-size: 30px;
         color: #555;
         text-align: center;
         }
         h1 {
         font-size: 22px;
         margin: 16px 0;
         color: #212121;
         }
         paper-material {
         background:#FFF;
         padding:8px;
         }
      </style>
      <paper-material>
         <sn-data-top id="dataTOP" 
            on-response-faixacontrato="_faixaContratoHandler"
            on-response-infocontrato="_infoContratoHandler">
         </sn-data-top>
         <div class="layout horizontal">
            <paper-dropdown-menu label="Cliente" id="cliente" on-iron-select="_changeHandlerCliente">
               <paper-listbox class="dropdown-content" selected="0" id="clienteListBox">
                  <template is="dom-repeat" items="{{clientList}}">
                     <paper-item>{{ item.nome }}</paper-item>
                  </template>
               </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu label="Faixa DWT" id="faixaDWT" on-iron-select="_refreshFaixasHandler">
               <paper-listbox class="dropdown-content" selected="0" id="faixaDWTListBox" style="width: 92px;">
                  <paper-item>Todos</paper-item>
                  <template is="dom-repeat" items="{{faixaList}}">
                     <paper-item>{{ item }}</paper-item>
                  </template>
               </paper-listbox>
            </paper-dropdown-menu>
            <paper-dropdown-menu label="Terminal" id="terminal" on-iron-select="_changeHandlerTerminal">
               <paper-listbox class="dropdown-content" selected="0" id="terminalList" style="width: 92px;">
                  <template is="dom-repeat" items="{{terminalList}}">
                     <paper-item style="width: 172px;">{{ item }}</paper-item>
                  </template>
               </paper-listbox>
            </paper-dropdown-menu>
            <style>
               #terminal /deep/ .dropdown-content {
               width: 219px;
               }
               #terminal /deep/ iron-dropdown {
               }
            </style>
            <paper-input 
               label="Contrato"         
               id="inputContrato" 
               value="*" 
               disabled></paper-input>
            <paper-input 
               label="Tipo de Tarifa"   
               id="inputTipoTarifa" 
               value="*" 
               disabled></paper-input>
            <paper-input 
               label="Moeda"            
               id="inputMoeda" 
               value="*" 
               disabled></paper-input>
            <paper-input label="Tarifa U$"  value="3.25"  disabled></paper-input>
         </div>
         <sn-tabela-mes 
            editable
            id="tableA"
            db="receita-qtd-navios" 
            on-tabela-mes-build="_tabelaMesBuildHandler"
            path="{{path}}"
            dimensions="{{ selectedFaixas }}" 
            header="Quantidade de Navios"></sn-tabela-mes>
         <sn-tabela-mes 
            editable
            id="tableB"
            db="receita-qtd-rebocadores" 
            on-tabela-mes-build="_tabelaMesBuildHandler"
            path="{{path}}"
            dimensions="{{ selectedFaixas }}" 
            header="Quantidade de Rebocadores"></sn-tabela-mes>
         <sn-tabela-mes 
            id="tableTarifas"
            db="receita-tarifa" 
            on-tabela-mes-build="_tabelaMesBuildHandler"
            path="{{path}}"
            dimensions="{{ selectedFaixas }}" 
            header="Tarifa"></sn-tabela-mes>
         <sn-tabela-mes 
            id="tabelaTotal"
            db="receita-total" 
            path="{{path}}"
            dimensions="{{ selectedFaixas }}" 
            header="Total"></sn-tabela-mes>
   </template>
   </paper-material>
   <script>
      Polymer({
      
        is: 'sn-view-detalhamento',
        properties:{
      
          faixaList:{
            type:Array
            
          },
      
          selectedFaixas : {type:Array},
          selectedCliente: {value:"Cliente1"},
          clientList : {value:[
      
            {nome:"Saveiros" ,num_contrato:"RJ1000153"},
            {nome:"Camorim"  ,num_contrato:"RJ1000158"},
            {nome:"Wallenius",num_contrato:"RJ1000590"}
          ]},
      
      
        },
        observers:['_buildPath(selectedCliente,selectedTerminal)'],
        _buildPath:function(){
          if( this.selectedCliente && this.selectedTerminal)
            this.path = this.selectedCliente + '/' + this.selectedTerminal
        },
        ready:function() {
          this._refreshFaixasHandler();
        },
        _refreshFaixasHandler:function(e,d){
          if(d && d.item && d.item.innerText) {
            if(d.item.innerText == "Todos") {
              this.selectedFaixas = this.faixaList;
            }
            else {
              this.selectedFaixas = [(d && d.item && d.item.innerText)];
            }
          }
          else
             this.selectedFaixas =_.first(this.faixaList)
        },
        _tabelaMesBuildHandler:function(){
            this.async(function(){
            var A = this.$.tableA.getStructuredData();
            var B = this.$.tableB.getStructuredData();
            var C = this.$.tableTarifas.getStructuredData();
      
            this.$.tabelaTotal.productABC(A,B,C);
      
            },500)
        },
        _changeHandlerCliente:function(e,d){
          this.selectedCliente = d.item.textContent;
      
          var num_contrato = _(this.clientList).groupBy('nome')[this.selectedCliente][0].num_contrato;
          this.$.inputContrato.value = num_contrato;
          this.$.dataTOP.getFaixasContrato(num_contrato);
          this.$.dataTOP.getInfoContrato(num_contrato);
          //volta para faixa todos
          this.$.faixaDWTListBox.selected  = 0;
      
        },
        _changeHandlerTerminal:function(e,d) {
          this.selectedTerminal = d.item.textContent;
          //volta para faixa todos
          this.$.faixaDWTListBox.selected  = 0;
          this.$.tableTarifas.fill(this.$.dataTOP.terminalFaixasTarifa[this.selectedTerminal],'VLR_LINER');
        },
        _faixaContratoHandler:function(e,d,s){
          this.selectedFaixas     = this.faixaList = this.$.dataTOP.faixaList;
          this.terminalList       = this.$.dataTOP.terminalList;
        },
        _infoContratoHandler:function(e,d){
          console.log(d);
          this.$.inputMoeda.value       = d.DESCRICAO_MOEDA;
          this.$.inputTipoTarifa.value  = d.CD_TIPO_CONTRATO
        }
      });
      
   </script>
</dom-module>